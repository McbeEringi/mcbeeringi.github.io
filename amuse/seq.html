<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>sky_seq indev</title>
		<link rel="preload" href="https://cdn.jsdelivr.net/npm/tone/build/Tone.js" as="script">
	</head>
	<body>
		<script src="https://mcbeeringi.github.io/sky/style.js" async></script>
		<style>
			:root{user-select:none;-webkit-user-select:none;}[contenteditable],.usa{user-select:auto;-webkit-user-select:auto;}
			html,body{height:100%;margin:0;position:relative;}textarea{width:100%;height:50vh;resize:none;box-sizing:border-box;}
			.disp{position:relative;}.disp>*{vertical-align:bottom;}
			#c{image-rendering:crisp-edges;width:100%;height:240px;background:#000a repeating-linear-gradient(#fffc,#fffc 16px,#fff8 16px,#fff8 48px,#fffa 48px,#fffa 64px,#fff8 64px,#fff8 80px,#fffa 80px,#fffa 96px,#fff8 96px,#fff8 112px);}
			#scr{width:100%;height:100%;position:absolute;top:0;overflow-x:scroll;scrollbar-width:thin;scrollbar-color:#0008 #0000;}#scr::webkit-scrollbar{background-color:#0000;height:8px;}#scr::webkit-scrollbar-thumb{background-color:#0008;border-radius:8px;}
			#scrw{height:10px;}
		</style>
		<div class="disp">
			<canvas id="c"></canvas>
			<div id="scr"><div id="scrw"></div></div>
		</div>
		<textarea id="dat"></textarea>
		<script src="https://mcbeeringi.github.io/src/requestIdleCallback.min.js"></script>
		<script>
			'use strict';
			let sel={active:{}};
			const i2n=['-9','-7','-5','-4','-2','0','2','3','5','7','8','10','12','14','15'],
			n2i={'-9':'0','-8':'0.5','-7':'1','-6':'1.5','-5':'2','-4':'3','-3':'3.5','-2':'4','-1':'4.5','0':'5','1':'5.5','2':'6','3':'7','4':'7.5','5':'8','6':'8.5','7':'9','8':'10','9':'10.5','10':'11','11':'11.5','12':'12','13':'12.5','14':'13','15':'14'},
			ctx=c.getContext('2d'),res=window.devicePixelRatio||1,
			frr=(ct,col,x,y,dx,dy,rl=0,rr=rl)=>{
				ct.fillStyle=col;
				ct.beginPath();
				ct.moveTo(x,y+rl);ct.arc(x+rl,y+rl,rl,Math.PI,Math.PI*1.5);
				ct.lineTo(x+dx-rr,y);ct.arc(x+dx-rr,y+rr,rr,Math.PI*1.5,0);
				ct.lineTo(x+dx,y+dy-rr);ct.arc(x+dx-rr,y+dy-rr,rr,0,Math.PI*.5);
				ct.lineTo(x+rl,y+dy);ct.arc(x+rl,y+dy-rl,rl,Math.PI*.5,Math.PI);
				ct.fill();
			},
			a2c=(x,b)=>{
				let pos=b?0:-scr.scrollLeft,note=[];
				const w=c.parentNode.clientWidth,
				core=y=>{
					for(var yi in y){
						let z=y[yi];
						if(typeof z=='object'){
							let tmp=pos;pos+=13;
							core(z);pos+=12;
							if(pos>0&&tmp<w)frr(ctx,'#0004',tmp,0,pos-tmp,240,4);
							pos+=1;
						}else{
							if(pos>-15&&pos<w){
								frr(ctx,(Math.min(sel.x1,sel.x2)<pos+16+scr.scrollLeft&&pos+scr.scrollLeft<Math.max(sel.x1,sel.x2))?'#8004':'#0004',pos,0,16,240,4,4);
								if(z)z.split(',').forEach(n=>{
									let tmp=false;
									if(n2i[n]==undefined){
										if(Number(n)>0)n=String((Number(n)+9)%24-9);
										else n=String((Number(n)+10)%24+14);
										tmp=true;
									}
									note.push([tmp,pos+1,225-Number(n2i[n])*16]);
								});
							}
							pos+=17;
						}
						if(pos>w&&!b)break;
					}
				};
				if(!b)ctx.clearRect(0,0,w,240);
				pos+=16;
				if(x&&Array.isArray(x)){
					core(x);pos+=w*.5;
					note.forEach(y=>frr(ctx,y[0]?'#fea8':'#fea',y[1],y[2],14,14,4));
					if(sel.active.main){
						let tmp=[sel.x1-scr.scrollLeft,sel.y1,sel.x2-sel.x1,sel.y2-sel.y1];
						ctx.fillStyle='#fff4';ctx.fillRect(...tmp);ctx.strokeStyle='#fff8';ctx.strokeRect(...tmp);
					}
					return pos;
				}
			};
			ctx.imageSmoothingEnabled=false;
			//ctx.fillStyle='#888';ctx.fillRect(0,0,c.width,c.height);
			dat.oninput=()=>scrw.style.width=a2c(JSON.parse(dat.value||0),1)+'px';
			(onresize=()=>{c.width=c.parentNode.clientWidth*res;c.height=240*res;ctx.scale(res,res);dat.oninput();})();
			scr.onwheel=e=>{e.preventDefault();scr.scrollLeft+=Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:e.deltaY;}
			scr.onscroll=()=>a2c(JSON.parse(dat.value||0));
			const movefx=()=>{
				const bscr=()=>{
					let p=sel.cx-window.innerWidth*.5;
					if(Math.abs(p)>window.innerWidth*.5-64){
						p=(p-Math.sign(p)*(window.innerWidth*.5-64))*.3;
						scr.scrollLeft+=p;
						sel.x2+=p;
					}
				};
				if(!sel.active.scroll)sel.active.scroll=setInterval(bscr,40);
				a2c(JSON.parse(dat.value||0));
			};
			scr.addEventListener('mousedown',e=>{sel.active.main=true;[sel.x1,sel.y1]=[e.clientX+scr.scrollLeft+window.scrollX,e.clientY+window.scrollY];});
			scr.addEventListener('mousemove',e=>{
				if(sel.active.main){
					sel.cx=e.clientX;
					[sel.x2,sel.y2]=[e.clientX+window.scrollX+scr.scrollLeft,e.clientY+window.scrollY];
					movefx();
				}
			});
			window.addEventListener('mouseup',()=>{sel.active.main=false;a2c(JSON.parse(dat.value||0));clearInterval(sel.active.scroll);sel.active.scroll=0;});
			scr.addEventListener('touchstart',e=>{if(!sel.active.main)sel.active.pre=setTimeout(()=>{sel.active.main=e.touches[0].identifier;[sel.x1,sel.y1]=[e.touches[0].clientX+scr.scrollLeft+window.scrollX,e.touches[0].clientY+window.scrollY];},200);});
			scr.addEventListener('touchmove',e=>{
				clearTimeout(sel.active.pre);
				Array.from(e.changedTouches).forEach(x=>{
					if(x.identifier==sel.active.main){
						e.preventDefault();
						sel.cx=x.clientX;
						[sel.x2,sel.y2]=[x.clientX+window.scrollX+scr.scrollLeft,x.clientY+window.scrollY];
						movefx();
					}
				});
			});
			['touchend','touchcancel'].forEach(x=>window.addEventListener(x,e=>{clearTimeout(sel.active.pre);if(Array.from(e.changedTouches,y=>y.identifier).includes(sel.active.main))dispatchEvent(new Event('mouseup'));}));

			dat.value=`["-4","",["-4","-4"],["-4","-4"],["-9,-4,3","","-4,-2","-2"],["-7,-2,5","","3,-2","5"],["-5,0,7","","0,10","10"],["-5,-2,12","","-2,7","5"],["-9,-4,3","3","-4,7","7"],["-7,-2,5","3","-2,3","5"],["-5,0,7","","0,10",""],["-5,-2,7","","-2",""],["-9,-4,3","","-4,-2",""],["-7,-2,5","","-2,3","5"],["0,-5,7","","0,10",""],["-5,-2,7","","-2,5",""],["-9,-4,3","","-4,7",""],["-7,-2,5","","-2,7",""],["-9,-5,3","","-5,-2",""],["-9,-5","","7","10"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-9,-5,3","","-5,-2",""],["-9,-5,3","","3,5","3,10,7"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,14,10",""],["-5,-2,15,10,3","","-2,3,7","5"],["-9,-4,0","","7,3,-4",""],["-7,-2,2,5,10","","-2,7,3","5"],["-9,-5,3","","-5,-2",""],["-9,-5,0","","-2",""],["-9,-4","7,3"],["","-4","7,3",""],["5,-7,-2,2","","3","-2"],["2","","5,2,-2",""],["3,-5,0","","","0"],["","-2"],["-2,-5","-4"],["-5","-5"],["-9,-4","7,3"],["7,3","-4","7,3",""],["5,-7,-2,2","3"],["2","-2,-7"],["-2,-5,0","7,3"],["5","3,-5,0"],["7,2,-2,5,-5",""],["5,-2,2,-5","3"],["-9,-4","-2"],["7,-9,-4,3","10,7,3"],["-7,-2","7,3"],["2,-2,-7","3"],["-5,0","-2"],["7,3,-5,0","10,7,3"],["-5,-2","7,3"],["2,-5,-2","5"],["3,-9,-4","","","-4"],["","-2,-4"],["3,-4,-9",""],["-4","3"],["5,-7,-2,2","3"],["8,-7,-2,5","8,5"],["7,3","-4,-7"],["2","2,-7,-5"],["3,-5,0","3"],["3","-2,-5,0"],["5,-9,-4,2",""],["3,-4","3"],["5,-7,-2,2","3"],["3","8,-7,-2,5"],["7,-2,-9,3",""],["7,-5,2,5","5","3","2"],["3,-5,0","","","0"],["3","7,-5,0,3"],["10,-4,-9,7,3","3"],["3","3,-4,-9"],["5,-7,2,-2","7,3"],["5,2,-7,-2","3"],["3,-2,-9",""],["2","2,-5,-7"],["3,-5,0","3"],["3","-2,-5,0"],["5,-9,-4,2",""],["3,-4","3"],["5,-7,-2,2","3"],["3","8,-7,-2,5"],["7,-2,-9,3",""],["7,-5,2,5","5","3","2"],["3,-5,0","","","0"],["3","7,-5,0,3"],["-5,-2,8,5","7,3"],["-5,-2,5","3"],["-9,-4,5,3",""],["-9,-4","-2"],["-4,-9,-2","-2"],["-4,-9,7,3","5,3"],["-7,-2,5,2",""],["3","-7,2,-2"],["-7,2,-4",""],["-5,-7,7,3","3"],["-9,-4,3","","-4,-2","-2"],["-7,-2,5,2","","3,-2","5"],["-5,0,7,3","","0,10,7,3","10,7,3"],["-5,-2,12,7,3","","-2,7,3","5"],["-9,-4,3","3","-4,7,3","7,3"],["-7,-2,5,2","3","-2,3","5,2"],["-5,0,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2",""],["-9,-4,3","","-4,-2",""],["-7,-2,5,2","","-2,3","5"],["0,-5,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2,5,3","3"],["-9,-4,3","","-4,7,3",""],["-7,-2,5,2","","-2,7,5,2",""],["-9,-5,3","","-5,-2",""],["-9,-5","","0","2"],["-9,-4,3","","-4,-2","-2"],["-7,-2,5,2","","3,-2","5"],["-5,0,7,3","","0,10,7,3","10,7,3"],["-5,-2,12,7,3","","-2,7,3","5"],["-9,-4,3","3","-4,7,3","7,3"],["-7,-2,5,2","3","-2,3","5,2"],["-5,0,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2",""],["-9,-4,3","","-4,-2",""],["-7,-2,5,2","","-2,3","5"],["0,-5,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2,5,3",""],["-9,-4,3","","-4,7,3",""],["-7,-2,5,2","","-2,7,5,2",""],["-9,-5,3","","-5,-2",""],["-9,-5","","7,3","7,3,10"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-9,-5,3","","-5,-2",""],["-9,-5,3","","3,5","3,10,7"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,14,10",""],["-5,-2,15,10,3","","-2,3,7","5"],["-9,-4,0","","7,3,-4",""],["-7,-2,2,5,10","","-2,7,3","5"],["-9,-5,3","","-5,-2",""],["-5,-9",""],"","","",""]`;
			dat.oninput();
		</script>
	</body>
</html>
