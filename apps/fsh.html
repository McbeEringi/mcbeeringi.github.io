<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<title>McbeEringi fsh</title>
		<link rel="stylesheet" href="../menu.css">
		<!--codemirror-->
		<script src="https://codemirror.net/lib/codemirror.js"></script>
		<link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css">
		<script>//http://glslsandbox.com/js/glsl.js
			CodeMirror.defineMode("glsl",(config,parserConfig)=>{var indentUnit=config.indentUnit,keywords=parserConfig.keywords||{},builtins=parserConfig.builtins||{},blockKeywords=parserConfig.blockKeywords||{},atoms=parserConfig.atoms||{},hooks=parserConfig.hooks||{},multiLineStrings=parserConfig.multiLineStrings;var isOperatorChar=/[+\-*&%=<>!?|\/]/;var curPunc;function tokenBase(stream,state){var ch=stream.next();if(hooks[ch]){var result=hooks[ch](stream,state);if(result!==false)return result;}if(ch=='"'||ch=="'"){state.tokenize=tokenString(ch);return state.tokenize(stream,state);}if(/[\[\]{}\(\),;\:\.]/.test(ch)){curPunc=ch;return "bracket";}if(/\d/.test(ch)){stream.eatWhile(/[\w\.]/);return "number";}if(ch=="/"){if(stream.eat("*")){state.tokenize=tokenComment;return tokenComment(stream,state);}if(stream.eat("/")){stream.skipToEnd();return "comment";}}if(isOperatorChar.test(ch)){stream.eatWhile(isOperatorChar);return "operator";}stream.eatWhile(/[\w\$_]/);var cur=stream.current();if(keywords.propertyIsEnumerable(cur)){if(blockKeywords.propertyIsEnumerable(cur))curPunc="newstatement";return "keyword";}if(builtins.propertyIsEnumerable(cur)){return "builtin";}if(atoms.propertyIsEnumerable(cur))return "atom";return "word";}function tokenString(quote){return (stream,state)=>{var escaped=false,next,end=false;while((next=stream.next())!=null){if(next==quote&&!escaped){end=true;break;}escaped=!escaped && next=="\\";}if(end||!(escaped||multiLineStrings))state.tokenize=tokenBase;return "string";};}function tokenComment(stream,state){var maybeEnd=false,ch;while(ch=stream.next()){if(ch=="/"&&maybeEnd){state.tokenize=tokenBase;break;}maybeEnd=(ch=="*");}return "comment";}function Context(indented,column,type,align,prev){this.indented=indented;this.column=column;this.type=type;this.align=align;this.prev=prev;}function pushContext(state,col,type){return state.context=new Context(state.indented,col,type,null,state.context);}function popContext(state){var t=state.context.type;if(t==")"||t=="]"||t=="}")state.indented=state.context.indented;return state.context=state.context.prev;}return{startState:(basecolumn)=>{return{tokenize:null,context:new Context((basecolumn||0)-indentUnit,0,"top",false),indented:0,startOfLine:true};},token:(stream,state)=>{var ctx=state.context;if(stream.sol()){if(ctx.align==null)ctx.align=false;state.indented=stream.indentation();state.startOfLine=true;}if(stream.eatSpace())return null;curPunc=null;var style=(state.tokenize||tokenBase)(stream,state);if(style=="comment"||style=="meta")return style;if(ctx.align==null)ctx.align=true;if((curPunc==";"||curPunc==":")&&ctx.type=="statement")popContext(state);else if(curPunc=="{")pushContext(state,stream.column(),"}");else if(curPunc=="[")pushContext(state,stream.column(),"]");else if(curPunc=="(")pushContext(state,stream.column(),")");else if(curPunc=="}"){while(ctx.type=="statement")ctx=popContext(state);if(ctx.type=="}")ctx=popContext(state);while(ctx.type=="statement")ctx=popContext(state);}else if(curPunc==ctx.type)popContext(state);else if(ctx.type=="}"||ctx.type=="top"||(ctx.type=="statement"&&curPunc=="newstatement"))pushContext(state,stream.column(),"statement");state.startOfLine=false;return style;},indent:(state,textAfter)=>{if(state.tokenize!=tokenBase&&state.tokenize!=null)return 0;var firstChar=textAfter&&textAfter.charAt(0),ctx=state.context,closing=firstChar==ctx.type;if(ctx.type=="statement")return ctx.indented +(firstChar=="{" ? 0 :indentUnit);else if(ctx.align)return ctx.column+(closing?0:1);else return ctx.indented +(closing?0:indentUnit);},electricChars:"{}"};});(function(){function words(str){var obj={},words=str.split(" ");for(var i=0;i<words.length;++i)obj[words[i]]=true;return obj;}var glslKeywords="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor";var glslBuiltins="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod";function cppHook(stream,state){if(!state.startOfLine)return false;stream.skipToEnd();return "meta";}function tokenAtString(stream,state){var next;while((next=stream.next())!=null){if(next=='"'&&!stream.eat('"')){state.tokenize=null;break;}}return "string";}CodeMirror.defineMIME("text/x-glsl",{name:"glsl",keywords:words(glslKeywords),builtins:words(glslBuiltins),blockKeywords:words("case do else for if switch while struct"),atoms:words("null"),hooks:{"#":cppHook}});}());
		</script>
		<script src="https://codemirror.net/addon/edit/closebrackets.js"></script>
		<link rel="stylesheet" href="https://codemirror.net/theme/ambiance.css">
		<!--=*=*=-->
		<style>
			:root{
				--pos:fixed;--menu_h:300px;--bg_col:#888a;
				--o_img:url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle r='20' cx='20' cy='20' fill='%23ccc'/%3E%3Ccircle r='2' cx='10' cy='12.5' fill='%23fff'/%3E%3Cpolygon points='15,14 15,11 30,11 30,14' fill='%23fff'%3E%3C/polygon%3E%3Ccircle r='2' cx='10' cy='20' fill='%23fff'/%3E%3Cpolygon points='15,21.5 15,18.5 30,18.5 30,21.5' fill='%23fff'%3E%3C/polygon%3E%3Ccircle r='2' cx='10' cy='27.5' fill='%23fff'/%3E%3Cpolygon points='15,29 15,26 30,26 30,29' fill='%23fff'%3E%3C/polygon%3E%3C/svg%3E%0A");
				--c_img:url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle r='20' cx='20' cy='20' fill='%23ccc'/%3E%3Cpolygon points='9,11 11,9 20,18 29,9 31,11 22,20 31,29 29,31 20,22 11,31 9,29 18,20' fill='%23fff'%3E%3C/polygon%3E%3C/svg%3E%0A");
				font-family:sans-serif;background-color:#222;color:#eee;image-rendering:pixelated;tab-size:2ex;
			}
			.flex{display:flex;justify-content:space-around;flex-wrap:wrap;align-items:flex-start;}
			#diffuse{width:100%;max-width:640px;height:100%;object-fit:contain;}#log{width:100%;color:#f22;margin:0;word-wrap:break-word;}
			.box{width:300px;min-height:320px;height:50vh;flex-grow:1;display:block;border:1px solid #888;margin:2px;}
			.CodeMirror{height:100%;width:100%;font-size:13px;}
			.cm-tab{
				background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='0,0 1,0 1,16 0,16' fill='%23444'%3E%3C/polygon%3E%3Cpolygon points='3,5 4,8 3,11 6,8' fill='%23444'%3E%3C/polygon%3E%3Cpolygon points='6,5 7,8 6,11 9,8' fill='%23444'%3E%3C/polygon%3E%3C/svg%3E");
				background-position:left;background-repeat:no-repeat;
			}
			.file{width:160px;height:120px;position:relative;border-radius:5px;border:1px solid #888;overflow:hidden;text-shadow:0 0 4px #000;background-size:contain;background-repeat:no-repeat;background-position:center;background-color:#000;margin:2px 0;}
			.file input[type=file]{position:absolute;cursor:pointer;margin:0;width:100%;height:100%;opacity:0;}
		</style>
	</head>
	<body>
		<canvas id="canvas" style="display:none;"></canvas>
		<div class="flex">
			<div class="box">
				<img id="diffuse" src="" alt="diffuse">
			</div>
			<div class="box">
				<textarea id="fsh" style="height:100%;width:100%;">precision mediump float;
uniform float time;
uniform vec2 resolution;
void main(){
	vec2 p = gl_FragCoord.xy/resolution;
	gl_FragColor = vec4(p,sin(time)*.5+.5,1);
}</textarea>
			</div>
		</div>
		<pre id="log"></pre>
		<div class="flex" style="max-width:800px;margin:0 auto;">
			<div class="file" id="inp0d"><input type="file" id="inp0" accept="image/*" onchange="read(this)">tex0</div>
			<div class="file" id="inp1d"><input type="file" id="inp1" accept="image/*" onchange="read(this)">tex1</div>
			<div class="file" id="inp2d"><input type="file" id="inp2" accept="image/*" onchange="read(this)">tex2</div>
			<div class="file" id="inp3d"><input type="file" id="inp3" accept="image/*" onchange="read(this)">tex3</div>
		</div>
		<h3>uniforms</h3>
		<p>
			uniform float time;<br>
			uniform vec2 resolution;<br>
			uniform sampler2D tex0;<br>
			uniform sampler2D tex1;<br>
			uniform sampler2D tex2;<br>
			uniform sampler2D tex3;<br>
		</p>
		<div class="menu">
			<input type="checkbox" id="example">
			<label for="example"></label>
			<div><div></div></div>
			<div>
				<h3>Config</h3>
				<div>
					img size<br>
					<input type="number" id="w_" value="16" oninput="if(this.value>0)c.width=this.value;else this.value=null" style="width:4em">
					*
					<input type="number" id="h_" value="16" oninput="if(this.value>0)c.height=this.value;else this.value=null" style="width:4em">
				</div><br>
				<div>
					<label>fps<br>
					<input type="number" id="fps_" value="60" oninput="if(this.value>0){clearTimeout(prc);fps=this.value;main();}else this.value=null"></label>
				</div><br>
				<div>
					<label>compile wait(ms)<br>
					<input type="number" id="wait_" value="1000" oninput="if(this.value<0)this.value=0"></label>
				</div><br>
				<p align="center" style="margin:0;font-size:11px;">
					powered by WebGL1.0 <br>
					special thanks to <a href="https://wgld.org" target="_blank">wgld.org</a> <br>
					<a href="https://twitter.com/mcbeeringi" target="_blank">@McbeEringi</a>.｡:+*
				</p>
			</div>
		</div>
		<script>
		var fsh_e = CodeMirror.fromTextArea(fsh, {
			mode: "text/x-glsl",theme: "ambiance",
			lineNumbers: true,
			tabSize: 2,indentUnit: 2,
			indentWithTabs: true,
			autoCloseBrackets: true
		});
		var comp_timer;
		fsh_e.on("change",()=>{clearTimeout(comp_timer);comp_timer=setTimeout(compile,wait_.value);});
		var imgurl=[];
		function read(_this) {
			var reader = new FileReader();
			var d = document.getElementById(_this.id+"d").style;
			var num = parseInt(_this.id.slice(-1));
			reader.addEventListener('load', ()=>{d.backgroundImage="url('"+reader.result+"')";imgurl[num]=reader.result;tex(num);}, false);
			reader.addEventListener('error',()=>{d.backgroundImage="linear-gradient(#f0f,#f0f)";log.innerText+="ERROR: "+_this.id+" loading failed"},false);
			reader.readAsDataURL(_this.files[0]);
			console.log(_this.id,imgurl,reader);
		}

		var c = document.getElementById("canvas");
		c.width = 8192;c.height = 8192;
		var gl = c.getContext("webgl") || c.getContext("experimental-webgl");
		c.width = w_.value;c.height = h_.value;
		gl.enable(gl.CULL_FACE);
		gl.frontFace(gl.CCW);//gl.frontFace(gl.CW);
		gl.enable(gl.DEPTH_TEST);
		gl.depthFunc(gl.LEQUAL);
		gl.enable(gl.BLEND);
		gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);
		gl.getExtension("OES_standard_derivatives");
		function create_shader(f){
			if(f){var shader = gl.createShader(gl.FRAGMENT_SHADER);var src = fsh_e.getValue();}
			else{var shader = gl.createShader(gl.VERTEX_SHADER); var src = "attribute vec2 UV;void main(){gl_Position=vec4(UV,0,1);}";}
			gl.shaderSource(shader, "#define round(x) floor(x+.5)\n"+src);
			gl.compileShader(shader);
			if(gl.getShaderParameter(shader, gl.COMPILE_STATUS))return shader;
			else log.innerText += gl.getShaderInfoLog(shader);
		}
		function create_program(vsh, fsh){
			var program = gl.createProgram();
			gl.attachShader(program, vsh);
			gl.attachShader(program, fsh);
			gl.linkProgram(program);
			log.innerText += gl.getProgramInfoLog(program);
			if(gl.getProgramParameter(program, gl.LINK_STATUS)){
				gl.useProgram(program);
				return program;
			}
		}
		function compile(){
			log.innerText = "";
			prg = create_program(create_shader(0),create_shader(1));
			fsh_e.save();
		}
		compile();
		//attribute
		var UV = gl.getAttribLocation(prg, "UV");
		var uv_v = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, uv_v);
		gl.enableVertexAttribArray(UV);
		gl.vertexAttribPointer(UV, 2, gl.FLOAT, false, 0, 0);
		gl.bindBuffer(gl.ARRAY_BUFFER, null);
		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());//ibo
			gl.bindBuffer(gl.ARRAY_BUFFER, uv_v);
			gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
			gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Int16Array([0,1,2, 3,2,1]), gl.STATIC_DRAW);
		//texture
		var texture = [];
		function tex(i){
			var img = new Image();
			img.onload = function() {
				var tex = gl.createTexture();
				gl.bindTexture(gl.TEXTURE_2D, tex);//バインドセット
				gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);//y反転
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);//読み込み
				gl.generateMipmap(gl.TEXTURE_2D);//生成
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);//拡大縮小
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);//端数処理
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
				gl.bindTexture(gl.TEXTURE_2D, null);//バインド解除
				texture[i] = tex;
				console.log("imgurl["+i+"] loaded");
			}
			img.src = imgurl[i];
		}
		var t = 0;
		var fps = fps_.value;
		var prc;//二重起動防止
		function main(){
			clearTimeout(prc);
			t+=1/fps;
			gl.clearColor(0,0,0,0);
			gl.clearDepth(1.);
			gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
			var uniform = [
				gl.getUniformLocation(prg, "time"),
				gl.getUniformLocation(prg, "resolution"),
				gl.getUniformLocation(prg, "tex0"),
				gl.getUniformLocation(prg, "tex1"),
				gl.getUniformLocation(prg, "tex2"),
				gl.getUniformLocation(prg, "tex3")
			];
			gl.uniform1f(uniform[0], t);
			gl.uniform2fv(uniform[1], [c.width,c.height]);

			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture[0]);
			gl.uniform1i(uniform[2], 0);
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D, texture[1]);
			gl.uniform1i(uniform[3], 1);
			gl.activeTexture(gl.TEXTURE2);
			gl.bindTexture(gl.TEXTURE_2D, texture[2]);
			gl.uniform1i(uniform[4], 2);
			gl.activeTexture(gl.TEXTURE3);
			gl.bindTexture(gl.TEXTURE_2D, texture[3]);
			gl.uniform1i(uniform[5], 3);

			gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);
			gl.flush();
			diffuse.src = c.toDataURL();

			prc =setTimeout(main, 1000/fps);
		}
		main();
		</script>
	</body>
</html>
